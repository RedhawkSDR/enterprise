<?xml version="1.0"?>
<!-- Licensed to the Apache Software Foundation (ASF) under one or more contributor 
	license agreements. See the NOTICE file distributed with this work for additional 
	information regarding copyright ownership. The ASF licenses this file to 
	you under the Apache License, Version 2.0 (the "License"); you may not use 
	this file except in compliance with the License. You may obtain a copy of 
	the License at http://www.apache.org/licenses/LICENSE-2.0 Unless required 
	by applicable law or agreed to in writing, software distributed under the 
	License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS 
	OF ANY KIND, either express or implied. See the License for the specific 
	language governing permissions and limitations under the License. -->
<!DOCTYPE Configure PUBLIC "-//Jetty//Configure//EN" "http://www.eclipse.org/jetty/configure_9_0.dtd">

<Configure id="Server" class="org.eclipse.jetty.server.Server">

	<!-- =========================================================== -->
	<!-- Set connectors -->
	<!-- =========================================================== -->
	<!-- One of each type! -->
	<!-- =========================================================== -->

	<!-- Use this connector for many frequently idle connections and for threadless 
		continuations. -->
	<New id="httpConfig" class="org.eclipse.jetty.server.HttpConfiguration">
		<Set name="secureScheme">https</Set>
		<Set name="securePort">
			<Property name="jetty.secure.port" default="8443" />
		</Set>
		<Set name="outputBufferSize">32768</Set>
		<Set name="requestHeaderSize">8192</Set>
		<Set name="responseHeaderSize">8192</Set>
		<Set name="sendServerVersion">true</Set>
		<Set name="sendDateHeader">false</Set>
		<Set name="headerCacheSize">512</Set>
	</New>

	<!-- =========================================================== -->
	<!-- SSL Configuration below -->
	<!-- Set up sslContext Factory with standard javax properties -->
	<!-- Latest docs: https://www.eclipse.org/jetty/documentation/9.4.x/configuring-ssl.html, remember to 
		use docs relevant to jetty available in your karaf instance
	 -->
	<New id="sslContextFactory" class="org.eclipse.jetty.util.ssl.SslContextFactory">
		<Set name="KeyStorePath"><SystemProperty name="javax.net.ssl.keyStore" /></Set>
		<Set name="KeyStorePassword"><SystemProperty name="javax.net.ssl.keyStorePassword" /></Set>
		<Set name="KeyManagerPassword"><SystemProperty name="javax.net.ssl.keyStorePassword" /></Set>
		<!-- Update below to real trustStore if you want to validate incoming client 
			certificates -->
		<Set name="TrustStorePath"><SystemProperty name="javax.net.ssl.keyStore" /></Set>
		<Set name="TrustStorePassword"><SystemProperty name="javax.net.ssl.keyStorePassword" /></Set>
  		<!-- Enable Forward Secrecy Ciphers. Note: this replaces the default Include Cipher list -->
  		<Set name="IncludeCipherSuites">
    		<Array type="String">
      			<Item>TLS_DHE_RSA.*</Item>
      			<Item>TLS_ECDHE.*</Item>
   			</Array>
 	 	</Set>
		<!-- Eliminate Old / Insecure / Anonymous Ciphers -->
  		<Call name="addExcludeCipherSuites">
    		<Arg>
      			<Array type="String">
        			<Item>.*NULL.*</Item>
       				<Item>.*RC4.*</Item>
        			<Item>.*MD5.*</Item>
        			<Item>.*DES.*</Item>
        			<Item>.*DSS.*</Item>
      			</Array>
    		</Arg>
    	</Call>
  		<!-- Eliminate Insecure Protocols -->
  		<Call name="addExcludeProtocols">
    		<Arg>
     			<Array type="java.lang.String">
       				<Item>SSL</Item>
       				<Item>SSLv2</Item>
       				<Item>SSLv2Hello</Item>
       				<Item>SSLv3</Item>
     			</Array>
   	 		</Arg>
  		</Call>
  		<Set name="renegotiationAllowed">FALSE</Set>		
	</New>
	
	<New id="httpsConnector" class="org.eclipse.jetty.server.ServerConnector">
		<Arg name="server"><Ref refid="Server"/></Arg>
		<Arg name="factories">
			<Array type="org.eclipse.jetty.server.ConnectionFactory">
              <Item>
                <New class="org.eclipse.jetty.server.SslConnectionFactory">
                  <Arg name="next">http/1.1</Arg>
                  <Arg name="sslContextFactory"><Ref refid="sslContextFactory"/></Arg>
                </New>
              </Item>
              <Item>
                <New class="org.eclipse.jetty.server.HttpConnectionFactory">
                  <Arg name="config"><Ref refid="httpConfig"/></Arg>
                </New>
              </Item>
       		</Array>		
		</Arg>
		<Set name="name">localhost:8182</Set>
 		<Set name="port">8182</Set>		
       <!-- 
       	<Set name="host"><Property name="jetty.ssl.host" deprecated="jetty.host" default="0.0.0.0"/></Set>
 		<Set name="port"><SystemProperty name="https.port" default="8443"/></Set>
        <Set name="idleTimeout"><Property name="jetty.ssl.idleTimeout" deprecated="ssl.timeout" default="30000"/></Set>
        <Set name="soLingerTime"><Property name="jetty.ssl.soLingerTime" deprecated="ssl.soLingerTime" default="-1"/></Set>
        <Set name="acceptorPriorityDelta"><Property name="jetty.ssl.acceptorPriorityDelta" deprecated="ssl.acceptorPriorityDelta" default="0"/></Set>
        <Set name="acceptQueueSize"><Property name="jetty.ssl.acceptQueueSize" deprecated="ssl.acceptQueueSize" default="0"/></Set>
        <Set name="name"><Property name="jetty.ssl.host" deprecated="jetty.host" default="0.0.0.0"/>:<SystemProperty name="https.port" default="8443"/></Set>
        -->
	</New>
	
	<Call name="addConnector">
		<Arg>
			<Ref refid="httpsConnector"/>
		</Arg>
	</Call>

	<!-- End of SSL Configuration -->
	<!-- =========================================================== -->

	<!-- =========================================================== -->
	<!-- Special server connectors -->
	<!-- =========================================================== -->
	<!-- This is a sample for alternative connectors, enable if needed -->
	<!-- =========================================================== -->
	<!-- <Call name="addConnector"> <Arg> <New class="org.eclipse.jetty.server.ServerConnector"> 
		<Arg name="server"> <Ref refid="Server" /> </Arg> <Arg name="factories"> 
		<Array type="org.eclipse.jetty.server.ConnectionFactory"> <Item> <New class="org.eclipse.jetty.server.HttpConnectionFactory"> 
		<Arg name="config"> <Ref refid="httpConfig" /> </Arg> </New> </Item> </Array> 
		</Arg> <Set name="host"> <Property name="jetty.host" default="localhost" 
		/> </Set> <Set name="port"> <Property name="jetty.port" default="8282" /> 
		</Set> <Set name="idleTimeout"> <Property name="http.timeout" default="30000" 
		/> </Set> <Set name="name">jettyConn1</Set> </New> </Arg> </Call> -->

	<!-- =========================================================== -->
	<!-- Configure Authentication Realms -->
	<!-- Realms may be configured for the entire server here, or -->
	<!-- they can be configured for a specific web app in a context -->
	<!-- configuration (see $(jetty.home)/contexts/test.xml for an -->
	<!-- example). -->
	<!-- =========================================================== -->
	<Call name="addBean">
		<Arg>
			<New class="org.eclipse.jetty.jaas.JAASLoginService">
				<Set name="name">karaf</Set>
				<Set name="loginModuleName">karaf</Set>
				<Set name="roleClassNames">
					<Array type="java.lang.String">
						<Item>org.apache.karaf.jaas.boot.principal.RolePrincipal
						</Item>
					</Array>
				</Set>
			</New>
		</Arg>
	</Call>
	<Call name="addBean">
		<Arg>
			<New class="org.eclipse.jetty.jaas.JAASLoginService">
				<Set name="name">default</Set>
				<Set name="loginModuleName">karaf</Set>
				<Set name="roleClassNames">
					<Array type="java.lang.String">
						<Item>org.apache.karaf.jaas.boot.principal.RolePrincipal
						</Item>
					</Array>
				</Set>
			</New>
		</Arg>
	</Call>

</Configure>
